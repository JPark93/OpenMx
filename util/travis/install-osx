#!/bin/bash

set -ve

# Workaround for travis-ci/travis-ci#8973
python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"

xcodebuild -version | head -n 1 | cut -d ' ' -f 2

id

if true; then
		cp ./util/gcc.conf ~/.R/Makevars
		curl -Lo /tmp/gcc.tar.gz 'https://sourceforge.net/projects/hpc/files/hpc/gcc/gcc-7.3-bin.tar.gz/download'
		curl -Lo /tmp/gfort.tar.gz 'https://sourceforge.net/projects/hpc/files/hpc/g95/gfortran-7.3-bin.tar.gz/download'
		sudo gtar --no-overwrite-dir --owner=travis --group=staff -zxf /tmp/gcc.tar.gz -C /
		sudo gtar --no-overwrite-dir --owner=travis --group=staff -zxf /tmp/gfort.tar.gz -C /
else
		# http://mac.r-project.org/openmp/
		curl -O https://mac.r-project.org/openmp/openmp-9.0.1-darwin17-Release.tar.gz
		sudo gtar --no-overwrite-dir --owner=travis --group=staff -zxf openmp-9.0.1-darwin17-Release.tar.gz -C /

		# echo '
		#     CPPFLAGS += -Xclang -fopenmp
		#     LDFLAGS += -lomp
		# ' > ~/.R/Makevars
fi

R --no-save -f util/update-dependencies.R --args ./DESCRIPTION.in
